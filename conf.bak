#!/bin/bash

user="admin"
password="admin"
localhost="localhost"
port=7180
version="v8"
cluster_name="cluster"

#HDFS
dfs_data_dir_list="/home/dataDir/data/osd/dfs/dn"
dfs_client_use_trash=true
dfs_name_dir_list="/home/dataDir/data/osd/dfs/nn"
fs_checkpoint_dir_list="/home/dataDir/data/osd/dfs/snn"
dfs_datanode_max_xcievers=8192
dfs_namenode_handler_count=32
dfs_namenode_service_handler_count=32
service_health_suppression_hdfs_canary_health=true
role_health_suppression_data_node_block_count=true
smon_client_config_overrides="<property><name>dfs.socket.timeout</name><value>30000</value></property><property><name>dfs.datanode.socket.write.timeout</name><value>30000</value></property><property><name>ipc.client.connect.max.retries</name><value>5</value></property><property><name>fs.permissions.umask-mode</name><value>000</value></property>"
dfs_namenode_servicerpc_address=8022

curl -X PUT -u "$user:$password" -H "content-type:application/json" \
-d "{\"items\": [{\"name\": \"dfs_data_dir_list\", \"value\": \"${dfs_data_dir_list}\"}]}" \
http://$localhost:$port/api/$version/clusters/$cluster_name/services/hdfs/roleConfigGroups/hdfs-DATANODE-BASE/config

curl -X PUT -u "$user:$password" -H "content-type:application/json" \
-d "{\"items\": [{\"name\": \"dfs_client_use_trash\", \"value\": ${dfs_client_use_trash}}]}" \
http://$localhost:$port/api/$version/clusters/$cluster_name/services/hdfs/roleConfigGroups/hdfs-GATEWAY-BASE/config

sleep 2s
curl -X PUT -u "$user:$password" -H "content-type:application/json" \
-d "{\"items\": [{\"name\": \"dfs_name_dir_list\", \"value\": \"${dfs_name_dir_list}\"}]}" \
http://$localhost:$port/api/$version/clusters/$cluster_name/services/hdfs/roleConfigGroups/hdfs-NAMENODE-BASE/config

curl -X PUT -u "$user:$password" -H "content-type:application/json" -d \
"{\"items\": [{\"name\": \"fs_checkpoint_dir_list\", \"value\": \"${fs_checkpoint_dir_list}\"}]}" \
http://$localhost:$port/api/$version/clusters/$cluster_name/services/hdfs/roleConfigGroups/hdfs-SECONDARYNAMENODE-BASE/config

sleep 2s
curl -X PUT -u "$user:$password" -H "content-type:application/json" \
-d "{\"items\": [{\"name\": \"dfs_datanode_max_xcievers\", \"value\": ${dfs_datanode_max_xcievers}}]}" \
http://$localhost:$port/api/$version/clusters/$cluster_name/services/hdfs/roleConfigGroups/hdfs-DATANODE-BASE/config

curl -X PUT -u "$user:$password" -H "content-type:application/json" \
-d "{\"items\": [{\"name\": \"dfs_namenode_handler_count\", \"value\": ${dfs_namenode_handler_count}}]}" \
http://$localhost:$port/api/$version/clusters/$cluster_name/services/hdfs/roleConfigGroups/hdfs-NAMENODE-BASE/config

sleep 3s
curl -X PUT -u "$user:$password" -H "content-type:application/json" \
-d "{\"items\": [{\"name\": \"dfs_namenode_service_handler_count\", \"value\": ${dfs_namenode_service_handler_count}}]}" \
http://$localhost:$port/api/$version/clusters/$cluster_name/services/hdfs/roleConfigGroups/hdfs-NAMENODE-BASE/config

sleep 2s
curl -X PUT -u "$user:$password" -H "content-type:application/json" \
-d "{\"items\": [{\"name\": \"service_health_suppression_hdfs_canary_health\", \"value\": ${service_health_suppression_hdfs_canary_health}}]}" \ 
http://$localhost:$port/api/$version/clusters/$cluster_name/services/hdfs/config

sleep 2s
curl -X PUT -u "$user:$password" -H "content-type:application/json" \
-d "{\"items\": [{\"name\": \"role_health_suppression_data_node_block_count\", \"value\": ${role_health_suppression_data_node_block_count}}]}" \
http://$localhost:$port/api/$version/clusters/$cluster_name/services/hdfs/roleConfigGroups/hdfs-DATANODE-BASE/config

curl -X PUT -u "$user:$password" -H "content-type:application/json" \
-d "{\"items\": [{\"name\": \"smon_client_config_overrides\", \"value\": \"${smon_client_config_overrides}\"}]}" \
http://$localhost:$port/api/$version/clusters/$cluster_name/services/hdfs/config

curl -X PUT -u "$user:$password" -H "content-type:application/json" \
-d "{\"items\": [{\"name\": \"dfs_namenode_servicerpc_address\", \"value\": \"${dfs_namenode_servicerpc_address}\"}]}" \
http://$localhost:$port/api/$version/clusters/$cluster_name/services/hdfs/roleConfigGroups/hdfs-NAMENODE-BASE/config



#KAFKA
auto_create_topics_enable=false
default_replication_factor=3
leader_imbalance_check_interval_seconds="3600"
leader_imbalance_per_broker_percentage="16"
replica_fetch_max_bytes=1073741824
num_replica_fetchers=10
log_cleaner_threads=4
zookeeper_service="zookeeper"
log_dirs="/home/dataDir/kafka/data"
log_roll_hours=240
num_io_threads=20
broker_max_heap_size=4096
broker_java_opts="-server -XX:+UseParNewGC -XX:MaxDirectMemorySize=1G -XX:+UseConcMarkSweepGC -XX:+CMSClassUnloadingEnabled -XX:+CMSScavengeBeforeRemark -XX:+DisableExplicitGC -Djava.awt.headless=true"
num_streams=4
mirror_maker_java_opts="-server -XX:+UseParNewGC -XX:+UseConcMarkSweepGC -XX:+CMSClassUnloadingEnabled -XX:+CMSScavengeBeforeRemark  -Djava.awt.headless=true"


sleep 2s
curl -X PUT -u "$user:$password" -H "content-type:application/json" \
-d "{\"items\": [{\"name\": \"auto.create.topics.enable\", \"value\": ${auto_create_topics_enable}}, {\"name\": \"default.replication.factor\", \"value\": ${default_replication_factor}}, {\"name\": \"leader.imbalance.check.interval.seconds\", \"value\": \"${leader_imbalance_check_interval_seconds}\"}, {\"name\": \"leader.imbalance.per.broker.percentage\", \"value\": \"${leader_imbalance_per_broker_percentage}\"}, {\"name\": \"replica.fetch.max.bytes\", \"value\": ${replica_fetch_max_bytes}}, {\"name\": \"num.replica.fetchers\", \"value\": ${num_replica_fetchers}}, {\"name\": \"log.cleaner.threads\", \"value\": ${log_cleaner_threads}}, {\"name\": \"zookeeper_service\", \"value\": \"${zookeeper_service}\"}]}" \
http://$localhost:$port/api/$version/clusters/$cluster_name/services/kafka/config

curl -X PUT -u "$user:$password" -H "content-type:application/json" \ 
-d "{\"items\": [{\"name\": \"log.dirs\", \"value\": \"${log_dirs}\"}]}" \
http://$localhost:$port/api/$version/clusters/$cluster_name/services/kafka/roleConfigGroups/kafka-KAFKA_BROKER-BASE/config

sleep 2s
curl -X PUT -u "$user:$password" -H "content-type:application/json" -d \
"{\"items\": [{\"name\": \"log.roll.hours\", \"value\": ${log_roll_hours}}, {\"name\": \"num.io.threads\", \"value\": ${num_io_threads}}, {\"name\": \"broker_max_heap_size\", \"value\": ${broker_max_heap_size}}, {\"name\": \"broker_java_opts\", \"value\": \"${broker_java_opts}\"}]}" \
http://$localhost:$port/api/$version/clusters/$cluster_name/services/kafka/roleConfigGroups/kafka-KAFKA_BROKER-BASE/config

curl -X PUT -u "$user:$password" -H "content-type:application/json" \
-d "{\"items\": [{\"name\": \"num.streams\", \"value\": ${num_streams}}, {\"name\": \"mirror_maker_java_opts\", \"value\": \"${mirror_maker_java_opts}\"}]}" \
http://$localhost:$port/api/$version/clusters/$cluster_name/services/kafka/roleConfigGroups/kafka-KAFKA_MIRROR_MAKER-BASE/config



#ZOOKEEPER
dataDir="/home/dataDir/zookeeper"
dataLogDir="/home/dataDir/zookeeper"

curl -X PUT -u "$user:$password" -H "content-type:application/json" \
-d "{\"items\": [{\"name\": \"dataDir\", \"value\": \"${dataDir}\"}, {\"name\": \"dataLogDir\", \"value\": \"${dataLogDir}\"}]}" \
http://$localhost:$port/api/$version/clusters/$cluster_name/services/zookeeper/roleConfigGroups/zookeeper-SERVER-BASE/config



#YARN
hdfs_service="hdfs"
zookeeper_service="zookeeper"
mapred_submit_replication=3
yarn_nodemanager_local_dirs="/home/dataDir/data/osd/yarn/nm"
yarn_nodemanager_log_dirs="/home/dataDir/data/osd/yarn/container-logs"
yarn_nodemanager_resource_memory_mb=81920
yarn_nodemanager_resource_cpu_vcores=24
yarn_nodemanager_resource_memory_mb=80
yarn_scheduler_maximum_allocation_vcores=80
yarn_scheduler_minimum_allocation_vcores=8

sleep 2s
curl -X PUT -u "$user:$password" -H "content-type:application/json" \ 
-d "{\"items\": [{\"name\": \"hdfs_service\", \"value\": \"${hdfs_service}\"}, {\"name\": \"zookeeper_service\", \"value\": \"${zookeeper_service}\"}]}" \
http://$localhost:$port/api/$version/clusters/$cluster_name/services/yarn/config

curl -X PUT -u "$user:$password" -H "content-type:application/json" \
-d "{\"items\": [{\"name\": \"mapred_submit_replication\", \"value\": ${mapred_submit_replication}}]}" \
http://$localhost:$port/api/$version/clusters/$cluster_name/services/yarn/roleConfigGroups/yarn-GATEWAY-BASE/config

sleep 2s
curl -X PUT -u "$user:$password" -H "content-type:application/json" \
-d "{\"items\": [{\"name\": \"yarn_nodemanager_local_dirs\", \"value\": \"${yarn_nodemanager_local_dirs}\"}, {\"name\": \"yarn_nodemanager_log_dirs\", \"value\": \"${yarn_nodemanager_log_dirs}\"}, {\"name\": \"yarn_nodemanager_resource_memory_mb\", \"value\": ${yarn_nodemanager_resource_memory_mb}}, {\"name\": \"yarn_nodemanager_resource_cpu_vcores\", \"value\": ${yarn_nodemanager_resource_cpu_vcores}}]}" \
http://$localhost:$port/api/$version/clusters/$cluster_name/services/yarn/roleConfigGroups/yarn-NODEMANAGER-BASE/config

curl -X PUT -u "$user:$password" -H "content-type:application/json" \
-d "{\"items\": [{\"name\": \"yarn_nodemanager_resource_memory_mb\", \"value\": ${yarn_nodemanager_resource_memory_mb}}, {\"name\": \"yarn_nodemanager_resource_cpu_vcores\", \"value\": ${yarn_nodemanager_resource_cpu_vcores}}]}" \
http://$localhost:$port/api/$version/clusters/$cluster_name/services/yarn/roleConfigGroups/yarn-NODEMANAGER-1/config

sleep 2s
curl -X PUT -u "$user:$password" -H "content-type:application/json" \
-d "{\"items\": [{\"name\": \"yarn_nodemanager_resource_memory_mb\", \"value\": ${yarn_nodemanager_resource_memory_mb}}, {\"name\": \"yarn_nodemanager_resource_cpu_vcores\", \"value\": ${yarn_nodemanager_resource_cpu_vcores}}]}" \
http://$localhost:$port/api/$version/clusters/$cluster_name/services/yarn/roleConfigGroups/yarn-NODEMANAGER-2/config

curl -X PUT -u "$user:$password" -H "content-type:application/json" \
-d "{\"items\": [{\"name\": \"yarn_nodemanager_resource_memory_mb\", \"value\": ${yarn_nodemanager_resource_memory_mb}}, {\"name\": \"yarn_nodemanager_resource_cpu_vcores\", \"value\": ${yarn_nodemanager_resource_cpu_vcores}}]}" \
http://$localhost:$port/api/$version/clusters/$cluster_name/services/yarn/roleConfigGroups/yarn-NODEMANAGER-3/config

sleep 2s
curl -X PUT -u "$user:$password" -H "content-type:application/json" \
-d "{\"items\": [{\"name\": \"yarn_scheduler_maximum_allocation_vcores\", \"value\": ${yarn_scheduler_maximum_allocation_vcores}}, {\"name\": \"yarn_scheduler_minimum_allocation_vcores\", \"value\": ${yarn_scheduler_minimum_allocation_vcores}}]}" \
http://$localhost:$port/api/$version/clusters/$cluster_name/services/yarn/roleConfigGroups/yarn-RESOURCEMANAGER-BASE/config



